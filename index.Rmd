---
title: "Creando paquetes de R"
subtitle: "⚔<br/>with xaringan"
author: "Lluís Revilla"
institute: "IDIBAPS, CIBEREHD"
date: "2022/03/07 (actualizado: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    self_contained: false
    lib_dir: libs
    seal: false
    css: ["default", "css/my-theme.css"]
    nature:
      beforeInit: "macros.js"
      ratio: 16:9
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    
---

```{r xaringan-setup, echo=FALSE}
xaringanExtra::use_tile_view()
xaringanExtra::use_freezeframe()
xaringanExtra::use_clipboard()
xaringanExtra::use_webcam()
xaringanExtra::use_share_again()
```


```{r metathis, echo=FALSE}
# https://www.garrickadenbuie.com/blog/sharing-xaringan-slides/
library(metathis)
meta() |>
  meta_name("github-repo" = "llrs/paquetesr") |> 
  meta_social(
    title = "Creando paquetes de R",
    description = paste(
      "Diapositivas para RSG-Spain BioInfo pills",
      "Descripción de cómo crear un paquete de R y subirlo un repositorio"
    ),
    url = "https://rsgspain.llrs.dev",
    image = "https://rsgspain.llrs.dev/index_files/figure-html/title_slide_screenshot.png",
    image_alt = paste(
      "Image of the first slide for 'Creando paquetes de R'", 
      # "Background with a plot of the packages on the queue of CRAN.", 
      "Done for the RSG-Spain on 2022/03/07 by Lluís Revilla Sancho"
    ),
    og_type = "website",
    og_author = "Lluís Revilla Sancho",
    twitter_card_type = "summary_large_image",
    twitter_creator = "@Lluis_Revilla"
  )
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE,
                      warning = FALSE, cache = TRUE,
                      fig.align = "center", fig.height = 6, 
                      fig.width = 15, fig.retina = 3)
library("dplyr")
library("stringr")
library("tidyr")
library("lubridate")
library("ggplot2")
library("patchwork")
library("ggrepel")
theme_slides <- theme_minimal() +
  theme(text = element_text(size = 16))
theme_set(theme_slides)
options(htmltools.dir.version = FALSE)
logic2string <- function(x){
  ifelse(x, "yes", "no")
}
```


layout: true

<div class="my-footer">
<a id="link" href="https://rsgspain.llrs.dev" style="position:absolute; left:2.5%">
rsgspain.llrs.dev</a>
<a href="https://twitter.com/Lluis_Revilla" style="position:absolute; left:45%"> Lluis_Revilla <svg viewBox="0 0 512 512" style="height:1em;position:relative;display:inline-block;top:.1em;" xmlns="http://www.w3.org/2000/svg">
  <path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
</svg></a></div>  

---
name: title-slide
class: center, middle
background-image: url("index_files/figure-html/title_slide_background.png")
background-size: contain
background-position: bottom

.top[
# Creando paquetes de R
]
<br><br>

**Para RSG-Spain**

[Lluís Revilla Sancho](https://llrs.dev)  
[IDIBAPS](https://www.clinicbarcelona.org/en/idibaps), [CIBEREHD](https://www.ciberehd.org/en)


2022/03/07


.minor[.minor[(Actualizado a: `r Sys.Date()` )]]

---
name:index

# Index


<br>

.pull-left[

 - [Creando buenos paquetes](#good-packages).


<br>

 - [Divulgando paquetes](#release-packages).

<br>

 - [Manteniendo paquetes](#maintaining-packages)

]

???

Creating packages based on the [previous workshop](https://llrs.dev/talk/workshop-creating-packages/) for R user group of Ghana. 

Release process based on the [useR!2021 talk](https://llrs.dev/talk/user-2021/)

Maintaining packages based on the [archived packages files.](https://llrs.dev/post/2021/12/07/reasons-cran-archivals/)

--

.pull-right[
![](https://c.tenor.com/abY7c2fitNIAAAAC/thumb-okay.gif)
]

---
name:good-packages
class: bold-last-item
# Desarrollando buenos paquetes

> Packages provide a mechanism for loading optional code, data and documentation as needed.

--

<br>
.center[Codigo]

???

Most common usage

--

<br>
.center[Datos]

???

Less used due to restrictions on size on CRAN

--

<br>
.center[Documentación]

???

In my opinion the most important aspect.

---
name:resources

## Recursos

- **[R extensions](https://cran.r-project.org/doc/manuals/r-release/R-exts.html "Offical complete instructions")**: documentación oficial, todo está respondido aquí
- **[R packages](https://r-pkgs.org/ "R packages")**: Un libro con los aspectos más relevantes y consejos prácticos para desarrollar paquetes.
- [Package primer](https://kbroman.org/pkg_primer/ "R package primer a minimal tutorial"): Web sobre cómo hacer un paquete.
- [Creating R packages from scratch by Tomas Westlake](https://r-mageddon.netlify.app/post/writing-an-r-package-from-scratch/ "Creating a cats package with usethis"): Post sobre cómo hacer paquetes.
- **[rOpenSci](https://devguide.ropensci.org/)**: Libro con consejos para hacer y mantener un paquete en buen estado.
- [Video](https://www.youtube.com/watch?v=IlWMkz769B4): Taller práctico sobre cómo hacer un paquete. 

**Hay muchos recursos!**

--

.center[

También puedes encontrar ayuda online (comprueba antes cómo interactuar en estos espacios)

Preguntar en tu comunidad local: RSG-Spain, facultad, grupo local de R...
[Preguntar en Twitter #rstats](https://www.t4rstats.com/)  
[Preguntar on Stack Overflow](https://stackoverflow.com/questions/5963269)  
[Preguntar en RStudio forum](https://community.rstudio.com/)
[Preguntar en la lista de desarrollo de paquetes de R](https://stat.ethz.ch/mailman/listinfo/r-package-devel)

]
???

Resources used to create this workshop

[Maëlle post](https://masalmon.eu/2017/12/11/goodrpackages/): how to write good packages is also recommended.


---

## Estructura

.left-column[

```{r include-graphic, echo=FALSE, out.width="100%"}
#| fig.alt = "Tree view of the dtplyr package repository on 2021/08/06."
knitr::include_graphics("images/tidyverse_dtplyr.png")
```

]


.right-column[ 


- Carpeta de `.github`: Archivos especificos de GitHub (No es necesario pero ayuda/[Contenido avanzazo](https://ghana.llrs.dev/#advanced))  
- Una **carpeta de R con [archivos *.R ](https://ghana.llrs.dev/#r-files)**: Tu código.  
- Una carpeta `man` con [archivos *.rd](https://ghana.llrs.dev/#rd-files): la documentación.  
- Una carpeta `tests`: [Comprueba el código](https://ghana.llrs.dev/#tests) del paquete.  
- Una carpeta [`vignette`](https://ghana.llrs.dev/#vignettes): Documentación larga sobre cómo usar el paquete.  
- Archivo `.Rbuildignore`: Un documento describiendo que omitir al construir el paquete.  
- Un archivo __[`DESCRIPTION`](https://ghana.llrs.dev/#description)__: Resumen y descripicón del paquete.  
- Achivo [`LICENSE`](https://ghana.llrs.dev/#licenses): Las condiciones en las que se difunde el paquete.  
- Archivo __[`NAMESPACE`](https://ghana.llrs.dev/#namespace)__: Qué necesita y comparte el paquete.  
- Archivo [`NEWS`](https://ghana.llrs.dev/#news): Que ha cambiado entre versiones.  
- Archivo [`README`](https://ghana.llrs.dev/#readme): Cómo instalar el paquete, cuándo es útil y algún ejemplo básico.

]

---
name: description

## DESCRIPTION

.pull-left[

```
Package: my_package
Title: Short Description in Title Case
Version: 0.0.9000
Authors@R: c(person(given = "Name",
             role = c("aut", "cre", "cph"),
             email = "my@email.com"),
             ...)
Description: A long description of the package
License: MIT + file LICENSE
Depends: 
    R (>= 4.1.2)
Imports: 
    methods
Suggests: 
    covr,
    knitr
VignetteBuilder: 
    knitr
Encoding: UTF-8
Language: en-US
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.1.1
```
]

???
Name of the package, description of the package, maintainer, relationships with other packages...
Language does not need to be on English, it can be in other languages

--

.pull-right[

**Package**: Nombre (Caracteres ASCII  and `.` and `-`).  
**Title**: Descripción corta.
**Version**: Al menos dos números.  
**`Authors@R`**: Información sobre el autor (auth) y el mantenedor (cre).  
**Description**: Descripción larga.  
**License**: Informaición sobre la licencia usada.  
**Depends**: Paquetes sin los que el programa no funciona.  
**Imports**: Paquetes usados.  
**Suggests**: Paquetes usados en la documentación o chequeo.  
**VignetteBuilder**: Cómo construir las vignettes.  
Otros campos:
- **URL**: Enlace a el código y páginas web.
- **BugReports**: Enlace donde reportar problemas.
- **Encoding**: ASCII o UTF-8.
- ...

]


---

## Archivos de R

1. Sólo código valido en R: funciones, objetos, ambientes que no no dependan de código previeamente ejecutado. 

2. Si el código usa funciones de otro paquete usa `package::function`

    3. Añade `package` al sito apropiado de [Description](#description)
    
    4. Añade `#' @importFrom package function` para documentar su uso

```r
meow <- function() {
    message("meow")
}
```

---
name: namespace
## NAMESPACE

Importa y exporta código:

```r
import(dplyr)
importFrom(methods, is)
export(meow)
```

???

This can be done manually no need to do it via other tools  (but recommended)

--

Si usas [roxygen2](https://cran.r-project.org/package=roxygen2) puedes documentarlo así:

```r
#' @import dplyr
#' @importFrom methods is
is_meow <- function(x){
    is(x, "meow")
}
#' @export # To make it available to others
meow <- function() {
    message("meow")
} 
```

Estas instrucciones irán al archivo NAMESPACE cuando se [actualize la documentación](#rd-files)

???
Important file!

---
name: rd-files

## Function documentation

.pull-left[
Usando roxygen2:

```r
#' Check if it is a meow
#'
#' Check if object is of class meow.
#' @param x A character string.
#'
#' @return A logical value with either TRUE or FALSE 
#'  if the object is a meow.
#' @export
#' @examples
#' is_meow("hi")
#' @importFrom methods is
is_meow <- function(x){
    is(x, "meow")
}
```
]

.pull-right[
Convierte estos comentario en archivos *.Rd mediante:

```r
document()
```
]

???

In Rstudio you can insert the skeleton with <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>Shift</kbd>+<kbd>R</kbd> .
In Rstudio you can convert the special comments into documentation with <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>D</kbd> .

---
class: bold-last-item

## Not covered here:

<br>

- Vignettes y artículos/demos

???

Articles are like vignettes but not checked by `R CMD check`

--

- Tests

???

With testthat, tinytest or other ways

--

- Página web con la documentación

???

Sites with pkgdown or other tools.

--

- Código compilado o otros lenguajes en paquetes de R.

???

C++, C, Fortran or linking to other languages, Java, perl; or other programs (cURl, xmldev)

--

- Other

???

How to choose a name of the package.  
How to write a good README and NEWS file.
Set up continuous integration tests.
How to pick up a license.

---
name: release-packages
# Releasing the package

<br><br>

.center[**Sharing** with others]

<br><br>
.center[A `my_package.tar.gz` file ] 

--

<br>

.center[Built with `R CMD build my_package`]

???

What does it mean? Building `R CMD build` and making it accessible to other people, example: `install.packages("http://biodev.cea.fr/sgcca/gliomaData_0.4.tar.gz", repos = NULL)`

What are the expectations? 

---
class: bold-last-item

## Choosing the right archive/repository

<br><br>

- Repository

.center[Git repository, svn, or none]

???

Repositories keep versions of code

--

- Archive

.center[CRAN, Bioconductor, Zenodo]

???

Archive do not delete content (normally)
Keep versions "released". 
Only CRAN, Bioconductor and additional repositories like [r-universe](https://r-universe.org), [drat](https://cran.r-project.org/package=drat), ... work via `install.packages`. 

--

- All

.center[GitHub + R-universe + (rOpenSci) + CRAN/Bioconductor + Zenodo]

???

Able to combine them, not mutually-exclusive

---

## Submitting the package


```{r init}
ros <- readRDS("output/github_rOpenSci_data__cleaned.RDS")
cran <- readRDS("output/cran_till_now.RDS")
bioc <- readRDS("output/submissions_bioconductor.RDS")
cran_dates <- readRDS("output/CRAN_archival_dates.RDS")
bioc_col <- c(low = "#87b13f", high = "#1a81c2")
bioc_colors <- scale_color_continuous(low = "#87b13f", high = "#1a81c2")
bioc_logo <- "https://bioconductor.org/images/logo_bioconductor.gif"
# bir <- image_read(bioc_logo)
ros_colors <- c(low = "#FFFFFF", high = "#73ADF2")
holidays <- data.frame(
  start = as.POSIXct(c("18/12/2020", "24/08/2021", "21/12/2021"), 
                     format = "%d/%m/%Y", tz = "UTC"), 
  end = as.POSIXct(c("04/01/2021", "01/09/2021", "03/01/2022"), 
                   format = "%d/%m/%Y", tz = "UTC")
)
days_holidays <- vector("list", nrow(holidays))
for (i in seq_len(nrow(holidays))) {
  days_holidays[[i]] <- seq(from = holidays$start[i], to = holidays$end[i], by = "1 day")
}
days_holidays <- unlist(days_holidays, FALSE, FALSE)
cran$snapshot_time <- lubridate::as_datetime(cran$snapshot_time, tz = "UTC")
```


Goals of a *submission*

- Sharing something of quality that can be useful to others.
- Make it easier for others to build upon your package.
- Other: work, grant, prestige ...

???

Submissions are though specially if coming from places with poor training
Lack of confidence/experience with reviews.

--

```{r proj}
project_links <- paste0("<a href=", c("https://cran.r-project.org/", "https://bioconductor.org/", "https://ropensci.org/"), ">", 
                        c("CRAN", "Bioconductor", "rOpenSci"), 
                        "</a>")
df <- data.frame(`Archives reviewing packages` = project_links,
           `Objectives of the reviews?` = c(
             "Non-trivial publication quality packages.",
             "Promote high-quality, well documented and interoperable.",
             "Drive the adoption of best practices with useful, transparent and constructive feedback."), check.names = FALSE)
knitr::kable(df, align = "c", )
```


???

Differences in objectives but all looking for quality
CRAN: Point errors, comments
Bioconductor: In detail comment of style, classes, dependencies, structure…
rOpenSci: guideline for reviewers (about style, tests, functions, description, documentation, …)


CRAN ~18000 packages, Bioconductor ~2000,  rOpenSci ~300
To work with this slides use xaringan::infinite_moon_reader()

--

.bottom[.center[Pick the right for you and your users]]


---
name:projects

### Project differences

.center[
```{r diff_proj}
objective <- c("Publication quality and non-trivial",
               "High quality, well documented and interoperable",
               "Drive the adoption of best practices with useful, transparent and constructive feedback")
upload <- c("tar.gz file", "fill an issue", "fill an issue")
setup <- c("None", "ssh key, subscribe mailing", "CI tests")
checks <- c("check --as-cran", "check; BiocCheck", "check --as-cran")
os <- rep("Windows, Unix, iOS", 3)
R_versions <- c("oldrel, release, patched, devel", "release, devel", "oldrel, release, devel")
cycle <- c("Always open", "2 annual releases", "Always open")
editors <- c("0", "0", "~10")
reviewers <- c("<b>~5 Volunteers</b>", "~10+Volunteers", "Volunteers")
guides <- c("<a href=https://cran.r-project.org/doc/manuals/r-release/R-exts.html>R-exts</a>", "<a href=https://www.bioconductor.org/developers/package-guidelines>Website</a>", "<a href=https://devguide.ropensci.org/index.html>Book</a>")
review_system <- c("email & ftp", "Github", "Github")
links <- c("https://cran.r-project.org/submit.html",
           "https://github.com/Bioconductor/Contributions/",
           "https://github.com/ropensci/software-review/")
repos <- c("CRAN", "Bioconductor", "rOpenSci")
df <- data.frame(Guides = guides,
                 Submit = paste0("<a href=", links, ">", upload, "</a>"),
                 Review = review_system,
                 Setup = setup, Checks = checks, OS = os,
                 Versions = R_versions, 
                 Cycle = cycle,
                 Editors = editors,
                 Reviewers = reviewers)
rownames(df) <- repos
knitr::kable(t(df), align = "c")
```

]

.center[.middle[Different setup, different review.]]

???

The different projects/archives have different setups.
*Read the table*
All of them first you need to pass the automatic checks in place before a human looks into it.
Will use data from the three projects but mostly refer to CRAN.

---

name:submissions

### Submissions


```{r submissions}
#| fig.alt = "Three bar plots with new submissions, each bar is a month: on the left CRAN with 16 months collected, on the middle Bioconductor with 5 years of data, on the right rOpenSci with 6 years of data. CRAN has about 300 monthly submissions, Bioconductor 30, rOpenSci 10. Some variance can be observed, specially on Bioconductor and rOpenSci."
library("ggplot2")
library("dplyr")
library("patchwork")
cran_submissions <- cran |> 
  filter(folder == "newbies") |> 
  distinct(package, .keep_all = TRUE) |> 
  group_by(month = lubridate::floor_date(snapshot_time, "month")) |>   count() |> 
  ggplot() +
  geom_col(aes(month, n)) +
  labs(x = element_blank(), y = element_blank(), 
       title = "CRAN")
bioc_submission <- bioc |> 
  filter(event == "created") |> 
  group_by(month = lubridate::floor_date(created, "month")) |> 
  count() |>
  ungroup() |> 
  ggplot() +
  geom_col(aes(month, n), fill = "#87b13f") +
  labs(x = element_blank(), y = element_blank(), 
       title = "Bioconductor")
ros_submissions <- ros |> 
  ungroup() |> 
  filter(event == "created") |> 
  mutate(presubmission = grepl("[Pp]re-?[Ss]ubmiss", title)) |> 
  filter(!presubmission) |> 
  group_by(month = lubridate::floor_date(created, "month")) |> 
  count() |> 
  ungroup() |> 
  ggplot() +
  geom_col(aes(month, n), fill = "#73ADF2") +
  labs(x = element_blank(), y = element_blank(), 
       title = "rOpenSci")
cran_submissions + bioc_submission + ros_submissions & 
  theme(axis.text.x = element_blank(),
        panel.grid.major.x = element_blank())
```


.center[
CRAN data thanks to the [incoming dashboard](https://lockedata.github.io/cransays/articles/dashboard.html).

]

???

One order of magnitude of difference between each other CRAN > Bioconductor > rOpenSci
Many variability on month
Also very few data collected from CRAN so far (Also there are some hiccups on CRAN collection, near the end of May the CRON job stopped working for a week. )

---

name:organization

### Organization

```{r cran-holidays}
#| fig.alt = "Line plot with number of packages on CRAN's folders newbies and pretest from September 2020 to January 2022 accounted hourly. Pretest is mainly below 10 packages and newbies around 25. There are same increase on newbies packages around October and after CRAN holidays of December-January (which is marked on red). There are two spikes on packages on pretest folder, one after the holidays and another one at the beginning of April."
man_colors <- RColorBrewer::brewer.pal(8, "Dark2")
library("lubridate")
names(man_colors) <- unique(cran$folder)
fdates <- function(x) {
  seq_days <- seq(from = min(x), to = max(x), by = 86400)
  keep_days <- mday(seq_days) %in% c(1, 7, 14, 21)
  breaks_dates <- seq_days[keep_days]
  floor_date(breaks_dates, unit = "days")
}
cran |> 
  group_by(folder, snapshot_time) |> 
  summarize(packages = n_distinct(package), .groups = "drop") |> 
  filter(folder %in% c("newbies", "pretest")) |>
  ggplot() +
  geom_rect(data = holidays, aes(xmin = start, xmax = end, ymin = 0, ymax = 200),
            alpha = 0.25, fill = "red") +
  annotate("text", x = holidays$start + (holidays$end - holidays$start)/2, 
           family = theme_get()$text[["family"]], 
           size = theme_get()$text[["size"]]/2.5, 
           y = 125, label = "Holidays/\nmaintenance") +
  geom_path(aes(snapshot_time, packages, col = folder, linetype = folder)) +
  scale_x_datetime(date_labels = "%y/%m", date_breaks = "1 month",
                   expand = expansion()) +
  scale_y_continuous(expand = expansion()) +
  scale_color_manual(values = man_colors[c("newbies", "pretest")]) +
  labs(x = element_blank(), y = element_blank(),
       title = element_blank(), col = "Folder", linetype = "Folder") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.6, 0.7))
```

.center[
Packages are moved by reviewers [between folders](https://llrs.dev/2021/01/cran-review/#cran-load).
]

???

Many folders but these two are the most important.
There isn't an explanation from CRAN about how do they work.
Pretest is resubmission (newer versions of packages) and also for newbies

---

name:submission-patterns

### Submissions patterns

```{r cran-day-month}
#| fig.alt = "Two plots with a loess estimation of the number of packages on the CRAN's folders newbies and pretest. On the left by day of month: Newbies has some dip at the beginning of the month and around day 20-29 but is around 70 packages a day, while pretests is constant around 50 packages each day. On the right plot the same data by day of week: many packages at the beginning of the week and fewer on the weekend. Pretest packages fall from 50 to around 30, while newbies drops from 80 to 70."
cran_times <- cran |> 
  mutate(date = as_date(snapshot_time),
         week = week(snapshot_time),
         mday = mday(snapshot_time),
         wday = wday(snapshot_time, locale = "en_GB.UTF-8", 
                     week_start = 1,
                     label = FALSE))
d <- c(1:7)
lab_names <- sort(lubridate::wday(d, locale = "en_GB.UTF-8", label = TRUE,
                     week_start =  1))
dmonth_breaks <- seq(0, 31, by = 7)
dmonth_breaks[1] <- 1
cran_dmonth <- cran_times |> 
  filter(folder %in% c("newbies", "pretest"),
         !snapshot_time %in% days_holidays) |> 
  arrange(folder, date, mday) |> 
  group_by(folder, date, mday) |> 
  summarize(packages = n_distinct(package),
            week = unique(week)) |> 
  group_by(folder, mday) |> 
  ggplot() +
  geom_smooth(aes(mday, packages, col = folder, linetype = folder), method = "loess") +
  labs(x = "Day of month", y = "Packages", col = "Folder", linetype = "Folder",
       title = element_blank()) +
  scale_color_manual(values = man_colors[c("newbies", "pretest")]) +
  scale_x_continuous(expand = expansion(), breaks = dmonth_breaks,
                       position = "top") +
  scale_y_continuous(expand = expansion()) 
cran_dweek <- cran_times |> 
  filter(folder %in% c("newbies", "pretest"),
         snapshot_time < holidays$start | snapshot_time  > holidays$end) |> 
  group_by(folder, date, wday) |> 
  summarize(packages = n_distinct(package),
            week = unique(week)) |> 
  ungroup() |> 
  ggplot() +
  geom_smooth(aes(wday, packages, col = folder, linetype = folder), method = "loess") +
  labs(x = "Day of week", y = "Packages", col = "Folder", 
       linetype = "Folder",
       title = element_blank()) +
  scale_color_manual(values = man_colors[c("newbies", "pretest")]) +
  scale_x_continuous(expand = expansion(), 
                     labels = lab_names, position = "top") +
  scale_y_continuous(expand = expansion(),
                     position = "right")
cran_dmonth + cran_dweek + plot_layout(guides = 'collect') &
  coord_cartesian(ylim = c(15, 90)) &
  guides(colour = guide_legend(nrow = 1, override.aes = list(fill = NA))) &
  theme(legend.position = "bottom")
```

.center[
Check [the dashboard](https://lockedata.github.io/cransays/articles/dashboard.html) before submitting?
]

???

Submit when you are ready, better on the queue than outside.

---
name:review-time

#### Review time

```{r cran-review}
#| fig.alt = "Histogram of time that a submission is on CRAN's queue. One big histogram from 0 to over 2000 hours, where most there are below 500h and decay in logarithmic pattern. Above it a zoom on the first week, split by 24h till 168h (1 week). Most submissions are less than 24h on the queue."
library("tidyr")
submission_folders <- cran_times |>
  group_by(package, resubmission_n, submission_n) |> 
  count(folder) |> 
  pivot_wider(names_from = folder, values_from = n, values_fill = 0) |> 
  ungroup()
submission_folders_total <- cran_times |>
  group_by(package, resubmission_n, submission_n) |> 
  count(folder) |> 
  summarize(h = sum(n)) |> 
  ungroup()
submissions_times <- cran_times |> 
  group_by(package, resubmission_n, submission_n) |> 
  summarize(start = min(snapshot_time), end = max(snapshot_time),
            .groups = "drop") 
rsubm <- full_join(submission_folders, submission_folders_total) |> 
  full_join(submissions_times)
p1 <- rsubm |> 
  group_by(package, submission_n) |> 
  summarise(h = sum(h), .groups = "drop") |> 
  ggplot() +
  geom_histogram(aes(h), binwidth = 24) +
  labs(title = element_blank(), x = "Hours", 
       y = "Submissions") +
  scale_x_continuous(expand = expansion()) +
  scale_y_continuous(expand = expansion())
p2 <- rsubm |> 
  group_by(package, submission_n) |> 
  summarise(h = sum(h), .groups = "drop") |> 
  filter(h <= 24*7) |> 
  ggplot() +
  geom_histogram(aes(h), binwidth = 24, boundary = 0.5) +
  labs(subtitle = "Zoom", x = "Hours", y =  "Submissions") +
  scale_x_continuous(expand = expansion(), breaks = seq(24, 24*8, by = 24)) +
  scale_y_continuous(expand = expansion()) +
  theme(panel.background = element_rect(fill = "lightyellow",
                                        colour = "lightyellow"),
        panel.grid.minor.x = element_blank(),
        plot.background = element_rect(fill = "lightyellow", 
                                       colour = "lightyellow"))
p1 + inset_element(p2, 0.2, 0.2, 1, 1)
```

.center[Reviews are short, brief and to the point.]

???

Median time on submissions ~`r median(rsubm$h, na.rm = TRUE)` hours, mean time ~`r mean(rsubm$h, na.rm = TRUE)` hours.
`r summary(rsubm$h)`


```{r title-plot, include=FALSE}
library("forcats")
lv <- levels(fct_reorder(rsubm$package, rsubm$start, .fun = min, .desc = FALSE))
ggplot(rsubm) +
  geom_linerange(aes(y = fct_reorder(package, start, .fun = min, .desc = FALSE),
                      x = start, xmin = start, xmax = end, 
                     col = as.factor(submission_n))) + 
  labs(x = element_blank(), y = element_blank(), title = element_blank(),
         col = "Submissions") +
  guides(col = "none") +
  scale_x_datetime(date_breaks = "1 month", 
                   expand = expansion(add = 2)) +
  scale_colour_viridis_d() +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        legend.position = c(0.15, 0.7))
```

---

#### Review speed 

```{r cran-submission-time}
#| fig.alt = "A plot with the loess estimation of hours for submission on CRAN. One line if the package is new another if it is an update. Updated packages are 5 hours on the queue while new packages start from 200 hours to 80 before CRAN holidays (end of December and beginning of January), increase again after holidays to around 120 to slowly decay till they reach 40 hours."
subm_time <- rsubm |> 
  group_by(package, submission_n) |> 
  summarize(d = as.Date(min(start)),
         new = ifelse(any(newbies != 0), "New", "Update"),
         h = sum(h), .groups = "drop") |> 
  filter(!d %in% days_holidays) |> 
  group_by(d, new) |> 
  summarize(m = median(h),
            s = sum(h),
            l = unname(quantile(h, 0.25)),
            h = unname(quantile(h, 0.75)),
            n = n())
subm_time |> 
  ggplot() +
  geom_rect(data = holidays, 
            aes(xmin = as.Date(start), xmax = as.Date(end)),
            ymin = 0, ymax = 250, alpha = 0.5, fill = "red") + 
  annotate("text", x = as.Date(holidays$start + (holidays$end - holidays$start)/2),
           family = theme_get()$text[["family"]], 
           size = theme_get()$text[["size"]]/2.5, 
           y = 150, label = "holidays/\nmaintenance") +
  geom_smooth(aes(d, m, col = new), span = 0.5, method = "loess") +
  geom_smooth(aes(d, h, col = new), span = 0.5, linetype = "dashed", 
              se = FALSE, method = "loess") +
  geom_smooth(aes(d, l, col = new), span = 0.5, linetype = "dashed", 
              se = FALSE, method = "loess") +
  scale_x_date(date_labels = "%m/%d", breaks = fdates, 
                   expand = expansion()) +
  geom_hline(aes(yintercept = time, col = new), data = . %>% group_by(new) %>% summarise(time = median(m), .groups = "drop"),
             linetype = "dashed", alpha = 0.5) +
  coord_cartesian(ylim = c(0, NA)) +
  scale_color_viridis_d() +
  labs(x = element_blank(), y = "Hours", 
       title = element_blank(), col = "Submission") +
  theme(legend.position = c(0.5, 0.7))
```

.center[Expect 3-7 days till your new package is on CRAN.]

???

Different time, can be shorter or longer.
Most longer need resubmission.
Resubmit with different version (makes it easier to track how many are).


```{r subm_time, echo=FALSE}
subm_time |> 
  group_by(new) |> 
  summarise(time = median(m), .groups = "drop")
```

CRAN: 60h
Bioconductor: most of them in 1 month
rOpenSci: in 2 months (seeking 2 reviewers and posting them).

```{r by_issue, include=FALSE}
trelative <- function(x) {
  created <- x$created
  event <- x$event
  start <- created[event == "created"]
  o <- difftime(created[!is.na(created)], start, units = "days")
  as.numeric(o)
}
reviewers <- function(assigners, unassigners) {
  ta <- table(assigners)
  tu <- table(unassigners)
  y <- 0
  n <- sum(ta) - sum(tu)
  reviewers <- vector("character", n)
  for (reviwer in names(ta)) {
    x <- ta[reviwer] - tu[reviwer]
    if (x >= 1 | is.na(x)) {
      y <- y + 1
      reviewers[y] <- reviwer
    }
  }
  reviewers
}
bioc_by_issue <- bioc |> 
  group_by(id) |> 
  summarize(time_window = difftime(max(created), min(created), units = "days"),
            events = n(), 
            diff_users = n_distinct(actor),
            diff_events = n_distinct(event),
            Approved = unique(Approved),
            approved = unique(approved),
            assignments = sum(event %in% "assigned"),
            reassigned = any(event %in% "unassigned"),
            assigners = list(reviewer[event %in% "assigned"]),
            author = actor[event == "created"],
            last_closed = ifelse(any(event == "closed"), max(created[which(event == "closed")]), max(created)),
            unassigners = list(reviewer[event %in% "unassigned"]),
            reviewers = list(reviewers(unlist(assigners, FALSE, FALSE), 
                                    unlist(unassigners, FALSE, FALSE))),
            reviewer_comments = sum(event == "commented" & 
                                      actor %in% unlist(reviewers) & created < last_closed, na.rm = TRUE),
            comments = sum(event == "commented" & created < last_closed),
            bot_comments = sum(event == "commented" & actor == "bioc-issue-bot" & created < last_closed),
            author_comments = sum(event == "commented" & actor == author& created < last_closed),
            closers = list(actor[event == "closed"]),
            openers = list(actor[event == "reopened"]),
            closed = sum(event == "closed") >= sum(event == "reopened") & any(event == "closed"),
            closer = list(setdiff(unlist(closers, FALSE, FALSE), 
                                    unlist(openers, FALSE, FALSE))),
            labels_added = list(label[event == "labeled"]),
            labels_removed = list(label[event == "unlabeled"]),
            labels_final = list(setdiff(unlist(labels_added, FALSE, FALSE), 
                                    unlist(labels_removed, FALSE, FALSE))),
            check_labels = all(unlist(labels_final, FALSE, FALSE) %in%
                                 label[event == "created"]),
            submitter = actor[event == "created"]
            
) |> 
  mutate(n_reviewers = lengths(reviewers),
         n_closers = lengths(closer))
bioc_by_issue1 <- bioc |> 
  group_by(id) |> 
  count(event) |> 
  filter(event != "created") |> 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) |>
  nest_by(.key = "event")
bioc_by_issue2 <- bioc |> 
  group_by(id) |> 
  count(actor) |> 
  pivot_wider(values_from = n, names_from = actor, values_fill = 0) |> 
  nest_by(.key = "actor")
bioc_by_issue <- bioc_by_issue |> 
  inner_join(bioc_by_issue1, by = "id") |> 
  inner_join(bioc_by_issue2, by = "id")
ros_by_issue <- ros |> 
  group_by(id) |> 
  summarize(time_window = difftime(max(created), min(created), units = "days"),
            events = n(), 
            diff_users = n_distinct(actor),
            author = actor[event == "created"],
            diff_events = n_distinct(event),
            assignments = sum(event %in% "assigned"),
            reassigned = any(event %in% "unassigned"),
            assigners = list(reviewer[event %in% "assigned"]),
            unassigners = list(reviewer[event %in% "unassigned"]),
            last_closed = ifelse(any(event == "closed"), max(created[which(event == "closed")]), max(created)),
            editors = list(reviewers(unlist(assigners, FALSE, FALSE), 
                                    unlist(unassigners, FALSE, FALSE))),
            editor_comments = sum(event == "commented" & 
                                      actor %in% unlist(editors) & created < last_closed, na.rm = TRUE),
            comments = sum(event == "commented" & created < last_closed),
            bot_comments = sum(event == "commented" & actor == "ropensci-review-bot" & created < last_closed),
            author_comments = sum(event == "commented" & actor == author & created < last_closed),
            closers = list(actor[event == "closed"]),
            openers = list(actor[event == "reopened"]),
            closed = sum(event == "closed") >= sum(event == "reopened") & any(event == "closed"),
            closer = list(setdiff(unlist(closers, FALSE, FALSE), 
                                    unlist(openers, FALSE, FALSE))),
            labels_added = list(label[event == "labeled"]),
            labels_removed = list(label[event == "unlabeled"]),
            labels_final = list(setdiff(unlist(labels_added, FALSE, FALSE), 
                                    unlist(labels_removed, FALSE, FALSE))),
            check_labels = all(unlist(labels_final, FALSE, FALSE) %in%
                                 label[event == "created"]),
            submitter = actor[event == "created"]
            
) |> 
  mutate(n_reviewers = lengths(editors),
         n_closers = lengths(closer))
ros_by_issue1 <- ros |> 
  count(event) |> 
  filter(event != "created") |> 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) |> 
  nest_by(.key = "event")
ros_by_issue2 <- ros |> 
  count(actor) |> 
  pivot_wider(values_from = n, names_from = actor, values_fill = 0) |> 
  nest_by(.key = "actor")
ros_by_issue <- ros_by_issue |> 
  inner_join(ros_by_issue1) |> 
  inner_join(ros_by_issue2)
```



---

name: users

#### Users role

```{r bioconductor-reviewers}
bioc_by_user0 <- bioc |>
  group_by(actor) |> 
  summarize(
    actions = n(),
    issues_participated = n_distinct(id),
    issues = list(unique(id)),
    events_participated = n_distinct(event),
  ) |> 
  mutate(is_reviewer = actor %in% unlist(bioc_by_issue$reviewers, FALSE, FALSE))
bioc_by_user1 <- bioc |> 
  group_by(actor) |> 
  count(event) |> 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) |> 
  nest_by(.key = "event")
bioc_by_user2 <- bioc |> 
  group_by(actor) |> 
  count(id) |> 
  pivot_wider(values_from = n, names_from = id, values_fill = 0) |> 
  nest_by(.key = "ids")
bioc_by_user <- bioc_by_user0 |> 
  full_join(bioc_by_user1, by = "actor") |> 
  full_join(bioc_by_user2, by = "actor")
bioc_users_plot <- bioc_by_user |> 
  filter(actor != "bioc-issue-bot" & !is.na(actor)) |>
  unnest(event) |> 
  filter(commented != 0) |> 
  ggplot() + 
  geom_abline(slope = 1, intercept = 0, alpha = 0.5, col = "gray") +
  geom_count(aes(issues_participated, actions, col = is_reviewer, shape = is_reviewer)) +
  labs(size = "Users", col = "Reviewer/Editor?", y = "Actions", 
       x = "Issues", shape = "Reviewer/Editor?",
       title = "Bioconductor")
```

```{r ropensci-editors}
ros_by_user <- ros |> 
  group_by(actor) |> 
  summarize(
    actions = n(),
    issues_participated = n_distinct(id),
    issues = list(unique(id)),
    events_participated = n_distinct(event),
  ) |> 
  mutate(is_editor = actor %in% unlist(ros_by_issue$editors, FALSE, FALSE))
ros_by_user1 <- ros |> 
  group_by(actor) |> 
  count(event) |> 
  pivot_wider(values_from = n, names_from = event, values_fill = 0) |> 
  nest_by(.key = "event")
ros_by_user2 <- ros |> 
  group_by(actor) |> 
  count(id) |> 
  pivot_wider(values_from = n, names_from = id, values_fill = 0) |> 
  nest_by(.key = "ids")
ros_by_user <- ros_by_user |> 
  inner_join(ros_by_user1) |> 
  inner_join(ros_by_user2)
ros_editors <- ros_by_user |> 
  filter(is_editor) |> 
  distinct(actor) |> 
  pull(actor)
ros_users_plot <- ros_by_user |> 
  filter(actor != "ropensci-reviewer-bot" & !is.na(actor)) |>
  unnest(event) |> 
  filter(commented != 0) |> 
  ggplot() + 
  geom_abline(slope = 1, intercept = 0, alpha = 0.5, col = "gray") +
  geom_count(aes(issues_participated, actions, col = is_editor, shape = is_editor)) +
  labs(size = "Users", col = "Different events", y = element_blank(), x = "Issues",
       title = "rOpenSci") 
```


```{r users-plots}
#| fig.alt = "Two plots showing the number of actions done by users and on how many submissions they have done that. On the left for Bioconductor and on the right for rOpenSci. The points size is according to how many users did so, there are two colors and shapes, one for regular users and one for editors (rOpenSci) or reviewers (Bioconductor). Most active people are core people from the project, but there are some regular users involved on many issues and doing many actions too."
pal <- RColorBrewer::brewer.pal(name = "Paired", n = 2)
man_col_v <- c("#440154FF", "#FF0000")
(bioc_users_plot + 
    scale_y_continuous(limits = c(1, 10000), trans = "log10", 
                       expand = expansion()) + 
    scale_color_manual(values = man_col_v) +
    ros_users_plot + 
    scale_y_continuous(limits = c(1, 10000), trans = "log10",
                       expand = expansion(), position = "right")  +
    scale_color_manual(values = man_col_v) +
    guides(col = "none", shape = "none") &
    scale_x_continuous(trans = "log10") &
   scale_size(limits = c(1, 50), breaks = c(1, 10, 20, 30, 40, 50),
              range = c(4, 4+6-1))) +
  plot_layout(guides = "collect")
```

.center[Some users are very involved.]

???

Bioconductor reviewers do a lot
rOpenSci editors too
Both organizations have a group of users involved on the package review system.
Even if Bioconductor doesn't explicitly ask for reviewers from the community.
Bioconductor are considering now how to improve the review system.
Omitted bots bioc-issue-bot and ropensci-review-bot (new March 2021).

---

### Comments

```{r comments}
#| fig.alt = "Four plots, in 2 rows and 2 columns, the first column for Bioconductor and the second data from rOpenSci. First row shows comments from reviewers in relation to author's comments (almost linear relation). On the second row other users vs author's comments. Only linear relationship on rOpenSci as this include the reviewers. "
bioc_author_reviewer_comments <- bioc_by_issue |> 
  select(id, Approved, comments, 
         reviewer_comments, author_comments, bot_comments) |> 
  filter(Approved != "Ongoing") |> 
  # pivot_longer(reviewer_comments:bot_comments, names_to = "source") |> 
  filter(!(author_comments == 0 & reviewer_comments == 0)) |> 
  ggplot() +
  geom_count(aes(author_comments, reviewer_comments), shape = 17, 
             col = "#87b13f") +
  labs(size = "Bioconductor", x = element_blank(), title = "Reviewers", y = element_blank())
bioc_auth_other_comments <- bioc_by_issue |> 
  select(id, comments, 
         reviewer_comments, author_comments, bot_comments) |> 
  # pivot_longer(reviewer_comments:bot_comments, names_to = "source") |> 
  filter(!(author_comments == 0 & reviewer_comments == 0)) |> 
  ggplot() +
  geom_count(aes(author_comments, comments - reviewer_comments - bot_comments - author_comments), shape = 17,
             col = "#87b13f") +
  labs(size = "Bioconductor", x = "Authors", title = "Other", y = element_blank())
ros_author_editor_comments <- ros_by_issue |> 
  select(id, comments, 
         editor_comments, author_comments, bot_comments) |> 
  # pivot_longer(reviewer_comments:bot_comments, names_to = "source") |> 
  filter(!(author_comments == 0 & editor_comments == 0)) |> 
  ggplot() +
  geom_count(aes(author_comments, editor_comments), col = "#73ADF2") +
  scale_size(limits = c(1, 30)) +
  labs(size = "rOpenSci", x = element_blank(), title = "Editors", y = element_blank())
ros_auth_other_comments <- ros_by_issue |> 
  select(id, comments, 
         editor_comments, author_comments, bot_comments) |> 
  # pivot_longer(reviewer_comments:bot_comments, names_to = "source") |> 
  filter(!(author_comments == 0 & editor_comments == 0)) |> 
  ggplot() +
  geom_count(aes(author_comments, comments - editor_comments - bot_comments - author_comments), col = "#73ADF2") +
  scale_size(limits = c(1, 30)) +
  labs(size = "rOpenSci", x = "Authors", title = "Reviewers & other", y = element_blank())
((bioc_author_reviewer_comments 
  + ros_author_editor_comments) /
    ( bioc_auth_other_comments + ros_auth_other_comments) & 
    scale_size(limits = c(1, 60), range = c(2, 7))) +
    plot_layout(guides = "collect")
```

.center[
A dialog between authors and reviewers & editors. 
]

???

Non reviewers users on bioconductor still chime in to help.

---
name:bot

### Bot role

```{r bioc-issue-bot}
#| fig.alt = "Tile plot with rows showing different message from bioc-issue-bot and columns being each issue for Bioconductor. The tile is colored by the number of times each bot posted the message. The plot shows how the bot changed with time and which are the most common feedback provided (in order of more feedback given): Build results, valid push, received, accepted, reviewer assigned. And common errors: missing repository, repost, fix version, closing issue, lacking ssh key, multiple repositories detected..."
library("stringr")
bioc_bot <- bioc |> 
  ungroup() |> 
  filter(event == "commented",
         actor == "bioc-issue-bot") |> 
  mutate(reason = case_when(
    startsWith(text, "Hi @") ~ "Received",
    startsWith(text, "Received a valid push") ~ "Valid push",
    str_detect(text, "^(\n)?Dear Package contributor,") ~ "Build result",
    startsWith(text, "A reviewer has been assigned to your package") ~ "Reviewer assigned",
    str_detect(text, "There is no repository called") ~ "Missing repository",
    str_detect(text, "Thanks for submitting your additional package") ~ "Additional package",
    str_detect(text, "has already posted ") ~ "Repost",
    str_detect(text, "for an extended period of time") ~ "Closing",
    str_detect(text, "DESCRIPTION file") ~ "Unmatch",
    str_detect(text, "Your package has been approved for building") ~ "Building",
    str_detect(text, "We only start builds when the `Version`") ~ "Update version",
    str_detect(text, "fix your version number") ~ "Fix version",
    str_detect(text, "a GitHub repository URL") ~ "Missing repository",
    str_detect(text, "more than one GitHub URL") ~ "Multiple repositories",
    str_detect(text, "Add SSH keys") ~ "SSH key",
    startsWith(text, "Your package has been accepted.") ~ "Accepted",
    TRUE ~ "Other"
  ))
bioc_bot |> 
  group_by(id) |> 
  count(reason, sort = TRUE) |> 
  ungroup() |> 
  ggplot() +
  geom_tile(aes(id, fct_reorder(reason, n, .fun = sum), col = n)) +
  scale_color_viridis_c(trans = "log10", expand = expansion()) +
  scale_x_continuous(expand = expansion()) +
  labs(x = "Issue", title = element_blank(), 
       y = element_blank(), col = "Comments")
```

.center[Bot helps on the process and changes with the process]

???

Bot provides feedback of many issues and actions performed. 
It can be changed/adapted to change in requirements or errors.
rOpenSci is going to have a bot too [ropensci-review-bot](https://github.com/ropensci-review-bot/). 

---
name: labels

### Labels

```{r labels}
#| fig.alt = "Two tile plots showing labels related to the review process on the vertical axis and issues on the horizontal axis. On the left Bioconductor and on the right rOpenSci. Bioconductor show many accepted packages few declined and more inactive issues. rOpenSci plot shows more labels which allow to better know the state of the review."
bioc_relative <- bioc |> 
  ungroup() |> 
  nest_by(id, .keep = FALSE) |> 
  summarize(t_relative = trelative(data), .groups = "drop")
bioc_labels <- bioc |> 
  ungroup() |> 
  mutate(t_relative = bioc_relative$t_relative) |> 
  filter(event == "labeled") |> 
  mutate(label = unlist(label),
         label = case_when(
           label == "1a. awaiting moderation" ~ "1. awaiting moderation", 
           label == "4a. accepted" ~ "3a. accepted",
           label == "ok_to_build" ~ "1. awaiting moderation",
           label == "awaiting moderation" ~ "1. awaiting moderation",
           label == "review-in-progress" ~ "2. review in progress",
           label == "TESTING" ~ NA_character_, 
           TRUE ~ label)) |> 
  filter(!is.na(label))
bioc_ord_label <- c("1. awaiting moderation",  
               "2. review in progress", "3a. accepted", 
               "3b. declined", "3c. inactive")
bioc_labels_plot <- bioc_labels |> 
  filter(label %in% bioc_ord_label) |> 
  group_by(id) |> 
  count(label, sort = TRUE) |> 
  ggplot() +
  geom_tile(aes(id, fct_relevel(label, rev(bioc_ord_label)), fill = n)) +
  labs(x = "Issue", y = element_blank(), title = "Bioconductor",
       fill = "Times")
ros_relative <- ros |> 
  ungroup() |> 
  nest_by(id, .keep = FALSE) |> 
  summarize(t_relative = trelative(data), .groups = "drop")
ros_labels <- ros |> 
  ungroup() |> 
  mutate(t_relative = ros_relative$t_relative) |> 
  filter(event == "labeled") |> 
  mutate(label = unlist(label),
         label = case_when(
           label == "reviewer-requested" ~ "2/seeking-reviewer(s)",
           label == "seeking-reviewers" ~ "2/seeking-reviewer(s)",
           label == "2/seeking-reviewers" ~ "2/seeking-reviewer(s)",
           label == "3/reviewers-assigned" ~ "3/reviewer(s)-assigned",
           label == "4/review-in-awaiting-changes" ~ "4/review(s)-in-awaiting-changes",
           label == "review-in-awaiting-changes" ~ "4/review(s)-in-awaiting-changes",
           label == "changes-in-awaiting-response" ~ "4/review(s)-in-awaiting-changes",
           label == "5/awaiting-reviewer-response" ~ "5/awaiting-reviewer(s)-response",
           label == "approved" ~ "6/approved",
           label == "topic:linquistics" ~ "topic:linguistics",
           TRUE ~ label
         ))
ros_ord_label <- c("0/presubmission",
               "1/editor-checks",  
               "2/seeking-reviewer(s)", "3/reviewer(s)-assigned", 
               "4/review(s)-in-awaiting-changes",
               "5/awaiting-reviewer(s)-response", 
               "6/approved")
ros_labels_plot <- ros_labels |> 
  group_by(id) |> 
  count(label, sort = TRUE) |> 
  ungroup() |> 
  filter(label %in% ros_ord_label) |> 
  ggplot() +
  geom_tile(aes(id, fct_relevel(label, rev(ros_ord_label)), fill = n)) +
  labs(x = "Issue", y = element_blank(), title = "rOpenSci",
       fill = "Times")
(bioc_labels_plot + ros_labels_plot) &
  scale_fill_viridis_c() &
  guides(fill = "none") +
  scale_x_continuous(expand = expansion())
```


.bottom[ .center[ Labels are used to indicate progress on the submission. ] ]

???

On bioconductor most problems with the submissions are not the package itself but not replying or chosing another venue.
rOpenSci provides more detailed questioning for scope of a package.

---

name:success-submissions
## Success submissions

```{r cran_success}
#| fig.alt = "A bar plot with packages submissions to CRAN on the x axis and on the vertical axis the number of packages. The bars are colored by if they are accepted or not. It is also split by new packages and updated packages. More new packages are not accepted on the first try than updates, but on resubmissions they are accepted."
approval_dates <- function(start, end, package, li) {
  dates <- li[[package]]
  dates <- dates[!is.na(dates)] # Too old packages don't have date
  if (is.logical(dates)) {
    return(NA)
  }
  
  diff_de <- difftime(dates, end, units = "day")
  r <- dates[abs(diff_de) <= 1]
  if (length(r) >= 1) {
    return(min(r))
  } else {
    return(NA)
  }
}
ap0 <- rsubm |> 
  group_by(package, submission_n) |> 
  summarize(start = min(start),
            end = max(end),
            new = ifelse(any(newbies != 0), "New", "Update"),
            accepted = approval_dates(start, end, unique(package), cran_dates),
            .groups = "drop")
ap <-  ap0 |> 
  group_by(submission_n, new) |> 
  count(Accepted = !is.na(accepted)) |> 
  ungroup() |> 
  mutate(submission_n = fct_relevel(as.factor(submission_n), as.character(1:10)))
success_submissions <- ggplot(ap) + 
  geom_col(aes(x = submission_n, y = n, fill = logic2string(Accepted))) +
  labs(x = "Submissions", y = "Packages", fill = "Accepted") +
  facet_wrap(~new, scales = "free_x") +
  scale_y_continuous(expand = expansion()) +
  scale_x_discrete(expand = expansion()) +
  scale_fill_viridis_d()
success_submissions
```

.bottom[.center[High approval rates!!]]

???

Bioconductor & rOpenSci 50%, some submissions are abandoned or do not fit the project.
Different problems faced by new packages and older ones. 
More in depth review requires 1 month for each reviewer. 

```{r subm_timeline}
ap |> 
  group_by(submission_n, new) |> 
  mutate(perc = n/sum(n)*100) |> 
  ungroup() |> 
  mutate(suspended = ifelse(!Accepted, n, 0),
         perc_suspended = suspended/sum(suspended)*100)
bioc |> 
  distinct(id, Approved) |> 
  count(Approved) |> 
  filter(Approved != "Ongoing") |> 
  mutate( perc = n/sum(n))
bioc_lab_wide <- bioc_labels |> 
  ungroup() |> 
  filter(label %in% bioc_ord_label) |> 
  pivot_wider(id_cols = id, values_from = t_relative, names_from = label,
              values_fn = last)
bioc_lab_wide |> 
  summarize(across( 2:5, .fn = function(x){median(x, na.rm = TRUE)}))
```


```{r subm_timeline-ros}
ros_lab_wide <- ros_labels |> 
  ungroup() |> 
  filter(label %in% ros_ord_label[2:7]) |> 
  pivot_wider(id_cols = id, values_from = t_relative, names_from = label,
              values_fn = last) |> 
  select(id, ros_ord_label[2:7])
res <- ros_lab_wide |> 
  # group_by(approved = ifelse(!is.na(`6/approved`), "Approved", "Pending?")) |> 
  summarize(
    s1 = median(`1/editor-checks`, na.rm = TRUE),
    s2 = median(`2/seeking-reviewer(s)` - `1/editor-checks`, na.rm = TRUE),
    s3 = median(`3/reviewer(s)-assigned` - `2/seeking-reviewer(s)`, na.rm = TRUE),
    s4 = median(`4/review(s)-in-awaiting-changes` - `3/reviewer(s)-assigned`, na.rm = TRUE),
    s5 = median(`5/awaiting-reviewer(s)-response` - `4/review(s)-in-awaiting-changes`, na.rm = TRUE),
    s6 = median(`6/approved` - `5/awaiting-reviewer(s)-response`, na.rm = TRUE))
colnames(res) <- ros_ord_label[2:7]
res |> 
  pivot_longer(cols = ros_ord_label[2:7]) |> 
  mutate(`Median days` = round(value, 1),
         `Total days` = round(cumsum(value), 1)) |> 
  select(name, `Median days`, `Total days`) |> 
  knitr::kable()
```



---

## Success submissions II

```{r success_rate}
#| fig.alt = "The plot on the right shows the acceptance rate of CRAN for the range of dates from 2020/09 to 2022/01. Two lines with one for new submissions which shows a consistent rate around 80% and package updates is around 90%. When the time series get too close to the last day data was collected the long reviews haven't finished so the rates fall."
success_dates <- ap0 |> 
  group_by(submission = lubridate::floor_date(start, "day"), new) |>
  count(Accepted = !is.na(accepted)) |> 
  mutate(perc = n/sum(n)) |> 
  ungroup() |> 
  filter(Accepted) |> 
  ggplot() + 
  geom_smooth(aes(submission, perc, linetype = new), span = 0.5, method = "loess") +
  scale_y_continuous(expand = expansion(), labels = scales::percent) +
  scale_x_datetime(date_labels = "%y/%m", date_breaks = "1 month", 
                   expand = expansion()) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.2, 0.6)) +
  labs(col = "Submission", title = "Acceptance rate", x = element_blank(),
       linetype = "Submission", y = element_blank())
success_dates
```

.center[High acceptance rates]

---

name:submit
## Prepare sumbission

.center[
.tip-submission[
.left[
__Prepare__]
.center[
 
  Manual to [create R packages](https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Creating-R-packages), [R Packages](https://r-pkgs.org/)  
  Follow policies ([CRAN](https://cran.r-project.org/web/packages/policies.html)) and **guidelines** ([Bioconductor](https://www.bioconductor.org/developers/package-submission/), [rOpenSci](https://devguide.ropensci.org/)).
]
]

<br>

.tip-submission[
.center[
**Check**

  CRAN pre-submission checks: [macOS](https://mac.r-project.org/macbuilder/submit.html), [Windows](https://win-builder.r-project.org/)
  
  [Use Rhub](https://builder.r-hub.io/), [Github Actions](https://github.com/r-lib/actions)]
]

]



???

Follow the detailed guidelines from Bioconductor and rOpenSci.
Fix any problem that you haven't detected previously (double check the [CRAN repository policy](https://cran.r-project.org/web/packages/policies.html)). 
Resubmit

---
name:celebrate
## Submit

.tip-submission[
.left[[Via web](https://cran.r-project.org/submit.html "Submission page") or  `devtools::release()`.]

]

--

.center[ Nervous]

--

.right[Wait..]

--

.tip-submission[ 
.left[***Resubmit***]
.center[
[Fix and explain](https://cran.r-project.org/web/packages/policies.html#Re_002dsubmission) on re-submission.]
]

--

.center[  `r emo::ji("party");emo::ji("party")` Celebrate `r emo::ji("party");emo::ji("party")` 
 
Announce to the community:  
`r emo::ji("mail")` [R-packages mailing   list](https://stat.ethz.ch/mailman/listinfo/r-packages)  
`r emo::ji("bird")` Social media  
`r emo::ji("family")` Family?  
Parties interested: users, R-user-groups, ...
]

---
class: bold-last-item
name:maintaining-packages
# Maintaining packages

<br>

- Keep up to date

Changes on R code, changes on dependencies, changes on CRAN checks.
    
???

Not in your hands to control, reactive work

--

<br>

- Change code of the package

Evaluate how to adapt your package
    
???

Better quality => Less work

--

<br>

- New releases

Provide new releases

???

Check also your dependencies and be mindful to users

---
class: bold-last-item
## Changing the package

.pull-left[
**New features**

Whenever you want

.minor[.minor[ On Bioconductor only after each release ] ]
]

???

Be mindful that you now "need" to support this.

--


.pull-right[
**Deprecating features/breaking changes**

- Notify users: NEWS, warnings , deprecate via [`.Deprecated`](https://search.r-project.org/R/refmans/base/html/Deprecated.html "Help page of .Deprecated")
]

--
.pull-right[
- And later on defunct via [`.defunct`](https://search.r-project.org/R/refmans/base/html/Defunct.html, "Help page of .Defunct")
]

--

.pull-right[

- If you have dependencies: notify with at least 1 month before submitting

]

???

Deprecate and defunct are important steps to notify users.  
Be mindful also to other developers that depend on your package: give them time, hear their concerns...

--

.bottom[.center[Make life easy to users and developers]]

---

## Keep checks clean


```{r checks}
#| fig.alt = "Plot with flavors on the y axis and percentages of packages with each status (OK, NOTE, WARNING, ERROR, FAILURE). Most flavors have the packages as OK or with notes. Only less than 10% are warnings or errors."
cpr <- tools::CRAN_check_results()
man_colors <- c("OK" = "green", "NOTE" = "darkgreen", 
                "WARNING" = "yellow", "ERROR" = "red", "FAILURE" = "black")
cpr |> 
  group_by(Package) |> 
  filter(n_distinct(Version) == 1) |> 
  ungroup() |> 
  group_by(Flavor) |> 
  count(Status, name = "packages") |> 
  mutate(perc = packages/sum(packages),
         Status = forcats::fct_relevel(Status, names(man_colors))) |> 
  ggplot() + 
  geom_col(aes(perc, Flavor, fill = Status)) +
  scale_x_continuous(expand = expansion(), labels = scales::percent_format()) +
  scale_fill_manual(values = man_colors) +
  labs(title = "Packages check status", x = element_blank())
```

.center[Most packages are in good shape.]

---

```{r download-archived}
url <- "https://cran.r-project.org/src/contrib/PACKAGES.in"
con <- url(url)
file <- read.dcf(con) |> 
  as.data.frame()
# Extract multiline comments
comments_l <- lapply(file$`X-CRAN-Comment`, function(x) {
  unlist(strsplit(x, "[\n]+"), FALSE, FALSE)
})
comments_c <- unlist(comments_l)
check_date <- function(ch){
  grepl(pattern = "([0-9]{4}-[0-9]{2}-[0-9]{2})", x = ch)
}
dates_comments <- check_date(comments_c)
df <- data.frame(package = rep(file$Package, lengths(comments_l)),
           comment = comments_c)
regex_date <- "([0-9]{4}-[0-9]{2}-[0-9]{2})"
regex_action <- "([Uu]narchived?|[Aa]rchived?|[Rr]enamed?|[Oo]rphaned?|[Rr]eplaced?|[Rr]emoved?)"
comments_df <- cbind(df, 
           strcapture(pattern = regex_date, x = df$comment, 
                      proto = data.frame(date = Sys.Date()[0])),
           strcapture(pattern = regex_action, x = df$comment,
                      proto = data.frame(action = character()))
           ) |> 
  filter(!is.na(comment)) |> 
  mutate(action = tolower(action))
# Check that count(comments_df, !is.na(date), !is.na(action), sort = TRUE) makes sense
# Handle rolled and no keyword used
# Handle CRAN-history
history_l <- lapply(file$`X-CRAN-History`, function(x) {
  unlist(strsplit(x, "[\n]+"), FALSE, FALSE)
})
history_c <- unlist(history_l)
history_df <- data.frame(package = rep(file$Package, lengths(history_l)),
                    comment = history_c) |> 
  filter(!is.na(comment))
history_df <- cbind(history_df,
                    strcapture(pattern = regex_date, x = history_df$comment, 
                               proto = data.frame(date = Sys.Date()[0])),
                    strcapture(pattern = regex_action, x = history_df$comment,
                               proto = data.frame(action = character()))
           ) |> 
  mutate(action = tolower(action))
history <- rbind(comments_df, history_df) |> 
  mutate(action = gsub(pattern = "e$", replacement = "ed", action)) |> 
  arrange(package)
```


## CRAN mainteinance

```{r plots_archiving}
#| fig.alt = "Movement of packages once on CRAN. Barplot with the number of movements on the y axis and the date of said action on the x axis. Many have been archived recently but also many have returned to CRAN."
history |>  
  filter(!is.na(date)) |> 
  group_by(action, month = as.Date(format(date, "%Y-%m-15"))) |> 
  summarise(n = n()) |> 
  ungroup() |> 
  ggplot() +
  geom_col(aes(month, n, fill = action)) +
  labs(y = element_blank(), fill = "Action", x = element_blank(),
       title = "Events on packages", subtitle = "by month") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion()) +
  scale_y_continuous(expand = expansion(add = c(0, 5))) +
  theme_minimal() +
  theme(legend.position = c(0.2, 0.7), text = element_text(size = 15))
```


.center[Packages might be archived from repositories]

---

## Common reasons of archiving:

```{r reasons}
#| fig.alt = "UpSet plot of the reasons of the archiving pacakges. Most common category are not_corrected, check and reminders. The most common intersections are also these three."
hist_expand <- history |> 
  filter(!is.na(date)) |> 
  mutate(not_corrected = grepl("not correct", comment, fixed = TRUE),
         request = grepl("request", comment, fixed = TRUE),
         maintainer = grepl("maintainer", comment, fixed = TRUE),
         request_maintainer =  maintainer & request & grepl("from", comment, fixed = TRUE),
         request_author = grepl("author", comment, fixed = TRUE) & request,
         reminders = grepl("reminders", comment, fixed = TRUE),
         install = grepl("install", comment, fixed = TRUE),
         email = grepl("email", comment, fixed = TRUE),
         email_error = email & grepl("undeliverable|bounce[sd]?|returned|rejected|refused", comment),
         unresponsive_maintainer = grepl("uncontactable|unresponsive", comment) & maintainer,
         check = grepl("check", comment, fixed = TRUE),
         licence = grepl("licen[cs]e", comment),
         update = grepl("updated?", comment),
         required = grepl("require[sd]?", comment),
         policy = grepl("policy violation", comment, fixed = TRUE),
         authorship = grepl("authorship", comment, fixed = TRUE),
         depends_archived = grepl("depends?", comment) & grepl("archived?", comment),
         )
```

```{r reasons_top}
archived_packages <- history |> 
  group_by(package) |> 
  filter(!is.na(date) & action == "archived") |> 
  pull(package) |> 
  unique()
counts <- hist_expand |> 
  filter(package %in% archived_packages,
         action != "unarchived") |> 
  select(-package, -action, -date, -comment) |> 
  colSums()
counts2 <- data.frame(type = names(counts), events = unname(counts)) |> 
  filter(!type %in% c("email", "request", "maintainer")) |> 
  arrange(-events)
library("ComplexUpset")
hist_expand |> 
  filter(package %in% archived_packages,
         action != "unarchived") |> 
  upset(intersect = c("not_corrected", "check", "reminders", "maintainer", "request", "policy", "depends_archived", "email_error"),
        min_size = 100)
```

.center[Check email!]

---

## Archived?

.pull-left[

![:scale 60% "Meme image of keep calm and carry on"](images/keep-calm-and-carry-on-original.jpg)
]

.pull-right[

.center[Understand why happened.]

.center[Fix and resubmit]  
(Your package will need to pass the new package checks again.)

.middle[

```{r back_to_cran}
download.file("https://cran.r-project.org/web/packages/packages.rds", 
              destfile = "packages.RDS") 
ap <- as.data.frame(readRDS("packages.RDS"))
ap <- distinct(ap, Package, .keep_all = TRUE)
rownames(ap) <- ap$Package
replaced <- file$Package[!is.na(file$Replaced_by)]
pkg_event <- hist_expand |> 
  filter(action == "archived" & !request_maintainer,
         !package %in% replaced) |> 
  count(package, sort = TRUE, name = "Events")
pkg_event |> 
  mutate(CRAN = logic2string(package %in% rownames(ap))) |> 
  group_by(CRAN) |> 
  count(name = "Packages") |>
  ungroup() |> 
  mutate(Proportion = scales::percent(Packages/sum(Packages))) |> 
  knitr::kable()
```

]
]

.center[  
Many archived packages return to CRAN.]

---

# Summary

- `r emo::ji("construction")` [Creating a package](#good-packages) is easy.

- `r emo::ji("package")` [Releasing a package](#release-packages) is doable.

- `r emo::ji("gear")` [Maintaining](#maintaining-packages) the high standards is not.

--

.middle[.center[
<br>
Thanks to the R core team past and current members.

Thanks to the CRAN, Bioconductor, rOpenSci teams.

All the contributors to packages used to make this presentation.

]]

--

.middle[.center[

<br><br>
**To you!**

]]


???

Thank also to the package authors (mainly tidyverse, ggplot2 and rhub, and gh).
Maëlle Salmon and Stephanie Locke for the CRAN dashboard.
And the organization.
rOpenSci review: [Video](https://www.youtube.com/watch?v=iJnn_9xKkqk)


```{r cleanup}
knitr::clean_cache()
```
